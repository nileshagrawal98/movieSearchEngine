<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies Search</title>
    <style>
        body {
            background-color: #2C3E50;
        }

        #nav_bar {
            max-width: 1140px;
            margin: auto;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }

        #search_bar {
            max-width: 800px;
            width: 80%;
            margin-right: 20px;
        }

        #search_bar>input {
            width: 100%;
            padding: 18px;
            color: #2980B9;
            height: 25px;
            box-sizing: border-box;
        }

        #search_result {
            display: none;
            width: 80%;
            max-height: 300px;
            max-width: 800px;
            background-color: #2980B9;
            overflow-y: scroll;
            color: white;
            position: absolute;

        }

        #search_result>div {
            display: flex;
            margin: 10px;
            background-color: #2C3E50;
            border-radius: 5px;
            padding: 5px;
            color: white;
            cursor: pointer;
        }

        #search_result>div>div:nth-of-type(2)>p:nth-of-type(1) {
            font-size: 20px;
            margin-top: 2px;
            margin-bottom: 1px;
        }

        #search_result>div>div:nth-of-type(2)>p:nth-of-type(2) {
            margin-top: 2px;
        }

        #search_result>div img {
            height: 80px;
            margin-right: 15px;
        }

        /* #nav_bar > button {
            background-color: #2980B9;
            border: 0;
            border-radius: 5px;
            color: white;
            padding: 10px;
            height: 39px;
        } */

        #movie_area {
            display: none;
            max-width: 1140px;
            background-color: #34495E;
            margin: auto;
            padding: 15px;
            box-shadow: 0 0 10px #2d3d4d;
        }

        #movie_area img {
            width: 100%;
        }

        #movie_area>div {
            display: flex;
            column-gap: 10px;
        }

        #details {
            color: white;
            font-size: 20px;
        }

        #details>p:nth-of-type(1) {
            margin-top: 0;
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 0;
        }

        #details>p:nth-of-type(1)>span {
            background-color: #2980B9;
            font-size: 15px;
            font-weight: 700;
            vertical-align: middle;
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: 5px;
        }

        #details>p:nth-of-type(2),
        #details>p:nth-of-type(3) {
            margin-top: 5px;
            font-size: 14px;
        }

        #details>div:nth-of-type(1)>div {
            display: flex;
            column-gap: 20px;
            margin: 0px 0px;
        }

        #details>div:nth-of-type(1)>h4 {
            margin-bottom: 10px;
        }

        #details>div:nth-of-type(1)>div>p {
            margin: 10px 0px;
        }

        #popular_container {
            max-width: 1140px;
            margin: auto;
            color: white;
        }

        #popular_container>h2 {
            text-align: center;
        }

        #popular_movies {
            display: grid;
            grid-template-columns: repeat(5, 18%);
            gap: 10px;
        }

        #popular_movies>div {
            background-color: #34495E;
            box-sizing: border-box;
            padding: 10px;
            cursor: pointer;
        }

        #popular_movies>div:hover {
            box-shadow: 0 0 18px #3d4b58ce;
        }

        #popular_movies>div>p {
            margin-top: 2px;
            margin-bottom: 1px;
        }

        #popular_movies>div>p:nth-of-type(2) {
            font-size: 12px;
        }

        #popular_movies img {
            width: 100%;
            margin-bottom: 2px;
        }

        footer {
            max-width: 1400px;
            margin: auto;
            color: white;
            text-align: center;
        }

        #nav_right_btns{
            display: flex;
            column-gap: 10px;
        }

        #nav_right_btns > div{
            display: flex;
        }

        .btn {
            background-color: #2980B9;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            color: white;
        }

        .btn:hover {
            background-color: #2f81b8;
            box-shadow: 0 0 10px rgba(3, 18, 59, 0.37);
            cursor: pointer;
        }

        #overlay {
            display: none;
            height: 100%;
            overflow:hidden;
        }

        #overlay_background {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .overlay-content  {
            width: 400px;
            margin: auto;
            margin-top: 10%;
            background-color: #34495E;
            padding: 30px;
            box-shadow: 0 0 10px rgba(3, 18, 59, 0.37);
            border-radius: 10px;
            position: absolute;
            top: 5%;
            left:35%;
            z-index: 4;
        }

        .overlay-content >h2 {
            margin: 0 0 10px;
            text-align: center;
            color: white;
        }

        .overlay-content >form {
            max-width: 350px;
            margin: auto;
            display: flex;
            flex-direction: column;
            row-gap: 8px;
        }

        .overlay-content >form>input {
            padding: 5px;
        }

        .overlay-content >form>button {
            padding: 10px;
            width: 50%;
            margin: auto;
            margin-top: 5px;
        }

        .alert-success {
            display: none;
            border: 4px solid green;
            border-radius: 10px;
            max-width: 350px;
            margin: 10px auto;
            text-align: center;
            color: green;
            background-color: lightgreen;
        }

        .alert-failed {
            display: none;
            border: 4px solid rgb(250, 98, 98);
            border-radius: 10px;
            max-width: 350px;
            margin: 10px auto;
            text-align: center;
            color: rgb(192, 25, 25);
            background-color: rgb(233, 164, 164);
        }

        #nav_user  {
            display: none;
            justify-content: center;
            align-items: center;
            column-gap: 5px;
            height: 40px;
            box-sizing: border-box;
        }

        #nav_user > p {
            margin: 0;
        }
    </style>
</head>

<body>

    <div id="nav_bar">

        <div id="search_bar">
            <input oninput="searchMovie()" type="text" id="movie" placeholder="Enter Movie Name To Search"
                onblur="removeResults()" />
            <div id="search_result"></div>
        </div>

        <div id="nav_right_btns">
            <div >
                <button class="btn" onclick="showOverlay('signup')">Sign Up</button>
            </div>
            <div >
                <button class="btn" onclick="showOverlay('login')">Login</button>
            </div>
        </div>

        <div id="nav_user" class="btn">
            <img src="https://img.icons8.com/color/48/000000/circled-user-male-skin-type-4--v1.png" height="30px"/>
            <p id="logged_username">Nilesh</p>
        </div>

        

    </div>


    <div id="movie_area">
        <h2 id="movie_name"></h2>

    </div>


    <div id="popular_container">
        <h2>Popular Movies</h2>

        <div id="popular_movies">
        </div>
    </div>

    <footer>
        <p>This page is using OMDb and TMDB API</p>
    </footer>

    <!-- Overlays By default remains hidden -->
    <div id="overlay" >
        <div id="overlay_background" onclick="closeOverlay()"></div>
        <div id="overlay_signup" class="overlay-content">
            <h2>Sign Up</h2>
            <div class="alert-success" id="signup_success">
                <p>SignUp Successful</p>
            </div>
            <div class="alert-failed" id="signup_failed">
                <p>SignUp Failed, User Already Exists</p>
            </div>
            <form onsubmit="SignUp(event)" id="signup_form">
                <input type="text" id="signup_name" min="1" placeholder="Name" required>
                <input type="mail" id="signup_mail" placeholder="Email" required>
                <input type="password" id="signup_pass" min="6" placeholder="Password" required>
                <input type="text" id="signup_username" min="1" placeholder="Username" required>
                <input type="tel" id="signup_mobile" min="10" placeholder="Mobile Number" required>
                <input type="text" id="signup_description" placeholder="Description">
                <button type="submit" class="btn">SignUp</button>
            </form>
        </div>
        <div id="overlay_login" class="overlay-content">
            <h2>Login</h2>
            <div class="alert-failed" id="login_failed">
                <p>Login Failed, Invalid login creadentials</p>
            </div>
            <form onsubmit="Login(event)" id="login_form">
                <input type="text" id="login_username" min="1" placeholder="Username" required>
                <input type="password" id="login_pass" placeholder="Password" required>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>
    </div>

</body>

<script>

    async function requestDataForTitle(movie_id) {
        // let movie = document.getElementById("movie").value;

        try {
            let res = await fetch(`http://www.omdbapi.com/?apikey=ce0b3791&i=${movie_id}`);

            let data = await res.json();
            console.log(data);

            showMovie(data);
        } catch (e) {
            console.log(e);
            showError(movie);

        }

        document.getElementById("movie_area").style.display = "block";
    }

    function showMovie(data) {

        let movie_area = document.getElementById("movie_area");
        movie_area.innerHTML = "";

        let container = document.createElement("div");

        let div1 = document.createElement("div");
        let image = document.createElement("img");
        image.src = data.Poster;

        div1.append(image);

        let div2 = document.createElement("div");
        div2.id = "details";

        let date = document.createElement("p");
        date.innerText = "Released Date: " + data.Released;

        let title = document.createElement("p");
        title.innerText = data.Title;

        if (Number(data.imdbRating) > 8.5) {
            let span = document.createElement("span");
            span.innerText = "Recommended";
            title.append(span);
        }

        let imdb = document.createElement("p");
        imdb.innerText = "IMDb Rating: " + data.imdbRating;

        let plot = document.createElement("p");
        plot.innerText = "Plot: " + data.Plot;


        let actors = document.createElement("p");
        actors.innerText = "Actors: " + data.Actors;

        let rating = document.createElement("div");
        let h4 = document.createElement("h4");
        h4.innerText = "Ratings: "
        rating.append(h4);
        let rating_data = data.Ratings;
        rating_data.forEach(e => {
            let div = document.createElement("div");
            let source = document.createElement("p");
            source.innerText = e.Source + ": ";
            let value = document.createElement("p");
            value.innerText = e.Value;
            div.append(source, value);
            rating.append(div);
        });

        div2.append(title, date, imdb, plot, actors, rating);

        container.append(div1, div2);

        movie_area.append(container);
    }

    function showError(movie) {
        let movie_area = document.getElementById("movie_area");
        movie_area.innerHTML = "";

        let h2 = document.createElement("h2");
        h2.innerText = `'${movie}' Not Found!`
        h2.style.textAlign = "center";
        h2.style.color = "white";

        let img = document.createElement("img");
        img.src = "http://driveinstyle.lk/img/img_gif/no_result_found.gif";

        movie_area.append(h2, img);
    }

    function showSearchResult(data) {

        let results = document.getElementById("search_result");

        results.innerHTML = "";

        console.log(data);

        results.style.display = "block";

        data.forEach(e => {
            let container = document.createElement("div");


            container.onclick = function () {
                requestDataForTitle(e.imdbID);
            }

            let div1 = document.createElement("div");

            let image = document.createElement("img");
            image.src = e.Poster;

            div1.append(image);

            let div2 = document.createElement("div");

            let name = document.createElement("p")
            name.innerText = e.Title;

            let type = document.createElement("p");
            type.innerText = e.Type;

            div2.append(name, type);

            container.append(div1, div2);

            results.append(container);

        })

    }

    async function requestDataForSearch() {
        let movie = document.getElementById("movie").value;

        try {

            let res = await fetch(`http://www.omdbapi.com/?apikey=ce0b3791&s=${movie}`);
            let data = await res.json();

            showSearchResult(data.Search);

        } catch (e) {
            console.log(e);
            let results = document.getElementById("search_result");

            results.innerHTML = "";

            let p = document.createElement("p");
            p.innerText = "No results found";
            p.style.textAlign = "center";
            results.append(p);
        }

    }

    let timer;

    function searchMovie() {
        clearTimeout(timer);

        timer = setTimeout(function () {
            requestDataForSearch()
        }, 600);
    }

    function removeResults() {
        setTimeout(function () {
            let results = document.getElementById("search_result");
            results.innerHTML = "";
            results.style.display = "none";
            document.getElementById("movie").value = "";
        }, 200)
    }

    async function getPopularMovies() {
        //TMDB key:2b4489582d1f2b3d42ac22f7e28d7e07

        let res = await fetch(`https://api.themoviedb.org/3/movie/popular?api_key=2b4489582d1f2b3d42ac22f7e28d7e07&language=en-US&page=1`);

        let data = await res.json();

        console.log(data.results);
        showPopularMovies(data.results);

    }

    getPopularMovies();

    function showPopularMovies(data) {
        let popular = document.getElementById("popular_movies");

        data.forEach(e => {
            let container = document.createElement("div");

            container.onclick = async function () {
                let res = await fetch(`https://api.themoviedb.org/3/movie/${e.id}/external_ids?api_key=2b4489582d1f2b3d42ac22f7e28d7e07`);
                let dat = await res.json();
                // console.log(dat.imdb_id);
                requestDataForTitle(dat.imdb_id);
                window.scrollTo(0, 0);
            }

            let image = document.createElement("img");
            image.src = `https://image.tmdb.org/t/p/w500${e.poster_path}`;

            let name = document.createElement("p");
            name.innerText = e.title;

            let date = document.createElement("p");
            date.innerText = "Release date: " + e.release_date;

            container.append(image, name, date);

            popular.append(container);

        })
    }


    function showOverlay(t) {
        let overlay = document.getElementById("overlay");
        overlay.style.display = "block";
        if (t == "signup") {
            document.getElementById("overlay_signup").style.display = "block";
            document.getElementById("overlay_login").style.display = "none";
        }else if(t == "login"){
            document.getElementById("overlay_signup").style.display = "none";
            document.getElementById("overlay_login").style.display = "block";
        }
        overlay.onscroll
    }

    //username: nilesh1998
    //email: nilesh@gmail.com
    //pass: 123456

    //username: pinkpanther
    //email: pinkpanther@mail.com
    //pass: pink123

    //username: sinchan
    //email: sinchan@mail.com
    //pass: sinchan123

    async function SignUp(e) {
        e.preventDefault();

        let form = document.getElementById("signup_form");

        let details = {
            name: form.signup_name.value,
            email: form.signup_mail.value,
            password: form.signup_pass.value,
            username: form.signup_username.value,
            mobile: form.signup_mobile.value,
            description: form.signup_description.value,
        }

        console.log(details);

        details = JSON.stringify(details);

        try {
            let res = await fetch("https://masai-api-mocker.herokuapp.com/auth/register", {
                method: "POST",
                body: details,
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            let data = await res.json();

            if (data.error) {
                showSignUpFailed();
            } else {
                showSignUpSuccessful();
            }

        } catch (e) {
            console.log(e);
        }

    }

    function showSignUpFailed() {
        // alert("failed");
        document.getElementById("signup_failed").style.display = "block";
        document.getElementById("signup_success").style.display = "none";
    }

    function showSignUpSuccessful() {
        // alert("success");
        document.getElementById("signup_failed").style.display = "none";
        document.getElementById("signup_success").style.display = "block";
    }

    function closeOverlay() {
        document.getElementById("overlay").style.display = "none";
    }

    async function Login(e) {
        e.preventDefault();

        document.getElementById("login_failed").style.display = "none";

        let form = document.getElementById("login_form");

        let details = {
            password: form.login_pass.value,
            username: form.login_username.value,
        }

        console.log(details);

        details = JSON.stringify(details);

        try {
            let res = await fetch("https://masai-api-mocker.herokuapp.com/auth/login", {
                method: "POST",
                body: details,
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            let data = await res.json();

            console.log(data);

            if (data.error) {
                showLoginFailed();
            } else {
                fetchUserData(form.login_username.value, data.token);
            }

        } catch (e) {
            console.log(e);
        }

    }

    async function fetchUserData(username, token){
        let res = await fetch(`https://masai-api-mocker.herokuapp.com/user/${username}`, {
            headers: {
                'Content-Type': 'application/json',

                Authorization: `Bearer ${token}`,
            },
        });

        let data = await res.json();

        console.log(data);

        showLoggedUser(data);
    }

    function showLoginFailed(){
        document.getElementById("login_failed").style.display = "block";
    }

    function showLoggedUser(data){
        let nav_user = document.getElementById("nav_user");
        nav_user.querySelector("#logged_username").innerText = data.username;
        nav_user.style.display = "flex";

        document.getElementById("nav_right_btns").style.display = "none";

        closeOverlay();
    }

</script>

</html>