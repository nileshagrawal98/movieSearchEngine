<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies Search</title>
    <style>
        body {
            background-color: #2C3E50;
        }

        #search_bar {
            max-width: 1400px;
            margin: auto;
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }

        #search_bar>div {
            max-width: 800px;
            width: 80%;
            margin-right: 20px;
        }

        #search_bar>div>input {
            width: 100%;
            padding: 18px;
            color: #2980B9;
            height: 25px;
            box-sizing: border-box;
        }

        #search_result {
            display: none;
            width: 80%;
            max-height: 300px;
            max-width: 800px;
            background-color: #2980B9;
            overflow-y: scroll;
            color: white;
            position: absolute;
            
        }

        #search_result > div {
            display: flex;
            margin: 10px;
            background-color: #2C3E50;
            border-radius: 5px;
            padding: 5px;
            color: white;
            cursor: pointer;
        }

        #search_result>div>div:nth-of-type(2)>p:nth-of-type(1) {
            font-size: 20px;
            margin-top: 2px;
            margin-bottom: 1px;
        }

        #search_result>div>div:nth-of-type(2)>p:nth-of-type(2) {
            margin-top: 2px;
        }

        #search_result>div img {
            height: 80px;
            margin-right: 15px;
        }

        #search_bar>button {
            background-color: #2980B9;
            border: 0;
            border-radius: 5px;
            color: white;
            padding: 10px;
            height: 39px;
        }

        #movie_area {
            display: none;
            max-width: 1400px;
            background-color: #34495E;
            margin: auto;
            padding: 15px;
            box-shadow: 0 0 10px #2d3d4d;
        }

        #movie_area img {
            width: 100%;
        }

        #movie_area>div {
            display: flex;
            column-gap: 10px;
        }

        #details {
            color: white;
            font-size: 20px;
        }

        #details>p:nth-of-type(1) {
            margin-top: 0;
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 0;
        }

        #details>p:nth-of-type(1)>span {
            background-color: #2980B9;
            font-size: 15px;
            font-weight: 700;
            vertical-align: middle;
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: 5px;
        }

        #details>p:nth-of-type(2),
        #details>p:nth-of-type(3) {
            margin-top: 5px;
            font-size: 14px;
        }

        #details>div:nth-of-type(1)>div {
            display: flex;
            column-gap: 20px;
            margin: 0px 0px;
        }

        #details>div:nth-of-type(1)>h4 {
            margin-bottom: 10px;
        }

        #details>div:nth-of-type(1)>div>p {
            margin: 10px 0px;
        }

        #popular_container{
            max-width: 1400px;
            margin: auto;
            color: white;
        }
        #popular_container > h2{
            text-align: center;
        }

        #popular_movies {
            display: grid;
            grid-template-columns: repeat(5, 18%);
            gap: 10px;
        }

        #popular_movies > div {
            background-color: #34495E;
            box-sizing: border-box;
            padding: 10px;
            cursor: pointer;
        }

        #popular_movies > div:hover {
            box-shadow: 0 0 18px #3d4b58ce;
        }

        #popular_movies > div > p {
            margin-top: 2px;
            margin-bottom: 1px;
        }

        #popular_movies > div > p:nth-of-type(2) {
            font-size: 12px;
        }

        #popular_movies img {
            width: 100%;
            margin-bottom: 2px;
        }

        footer{
            max-width: 1400px;
            margin: auto;
            color: white;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="search_bar">

        <div>
            <input oninput="searchMovie()" type="text" id="movie" placeholder="Enter Movie Name To Search"
                onblur="removeResults()" />
            <div id="search_result"></div>
        </div>


        <!-- <button onclick="requestDataForTitle()">Search Movie</button> -->

    </div>


    <div id="movie_area">
        <h2 id="movie_name"></h2>

    </div>


    <div id="popular_container">
        <h2>Popular Movies</h2>

        <div id="popular_movies">
        </div>
    </div>

    <footer>
        <p>This page is using OMDb and TMDB API</p>
    </footer>


</body>

<script>

    async function requestDataForTitle(movie_id) {
        // let movie = document.getElementById("movie").value;

        try {
            let res = await fetch(`http://www.omdbapi.com/?apikey=ce0b3791&i=${movie_id}`);

            let data = await res.json();
            console.log(data);

            showMovie(data);
        } catch (e) {
            console.log(e);
            showError(movie);

        }

        document.getElementById("movie_area").style.display = "block";
    }

    function showMovie(data) {

        let movie_area = document.getElementById("movie_area");
        movie_area.innerHTML = "";

        let container = document.createElement("div");

        let div1 = document.createElement("div");
        let image = document.createElement("img");
        image.src = data.Poster;

        div1.append(image);

        let div2 = document.createElement("div");
        div2.id = "details";

        let date = document.createElement("p");
        date.innerText = "Released Date: " + data.Released;

        let title = document.createElement("p");
        title.innerText = data.Title;

        if (Number(data.imdbRating) > 8.5) {
            let span = document.createElement("span");
            span.innerText = "Recommended";
            title.append(span);
        }

        let imdb = document.createElement("p");
        imdb.innerText = "IMDb Rating: " + data.imdbRating;

        let plot = document.createElement("p");
        plot.innerText = "Plot: " + data.Plot;


        let actors = document.createElement("p");
        actors.innerText = "Actors: " + data.Actors;

        let rating = document.createElement("div");
        let h4 = document.createElement("h4");
        h4.innerText = "Ratings: "
        rating.append(h4);
        let rating_data = data.Ratings;
        rating_data.forEach(e => {
            let div = document.createElement("div");
            let source = document.createElement("p");
            source.innerText = e.Source + ": ";
            let value = document.createElement("p");
            value.innerText = e.Value;
            div.append(source, value);
            rating.append(div);
        });

        div2.append(title, date, imdb, plot, actors, rating);

        container.append(div1, div2);

        movie_area.append(container);
    }

    function showError(movie) {
        let movie_area = document.getElementById("movie_area");
        movie_area.innerHTML = "";

        let h2 = document.createElement("h2");
        h2.innerText = `'${movie}' Not Found!`
        h2.style.textAlign = "center";
        h2.style.color = "white";

        let img = document.createElement("img");
        img.src = "http://driveinstyle.lk/img/img_gif/no_result_found.gif";

        movie_area.append(h2, img);
    }

    function showSearchResult(data) {

        let results = document.getElementById("search_result");

        results.innerHTML = "";

        console.log(data);

        results.style.display = "block";

        data.forEach(e => {
            let container = document.createElement("div");


            container.onclick = function () {
                requestDataForTitle(e.imdbID);
            }

            let div1 = document.createElement("div");

            let image = document.createElement("img");
            image.src = e.Poster;

            div1.append(image);

            let div2 = document.createElement("div");

            let name = document.createElement("p")
            name.innerText = e.Title;

            let type = document.createElement("p");
            type.innerText = e.Type;

            div2.append(name, type);

            container.append(div1, div2);

            results.append(container);

        })

    }

    async function requestDataForSearch() {
        let movie = document.getElementById("movie").value;

        try {

            let res = await fetch(`http://www.omdbapi.com/?apikey=ce0b3791&s=${movie}`);
            let data = await res.json();

            showSearchResult(data.Search);

        } catch (e) {
            console.log(e);
            let results = document.getElementById("search_result");

            results.innerHTML = "";

            let p = document.createElement("p");
            p.innerText = "No results found";
            p.style.textAlign = "center";
            results.append(p);
        }

    }

    let timer;

    function searchMovie() {
        clearTimeout(timer);

        timer = setTimeout(function () {
            requestDataForSearch()
        }, 600);
    }

    function removeResults() {
        setTimeout(function () {
            let results = document.getElementById("search_result");
            results.innerHTML = "";
            results.style.display = "none";
            document.getElementById("movie").value = "";
        }, 200)
    }

    async function getPopularMovies() {
        //TMDB key:2b4489582d1f2b3d42ac22f7e28d7e07

        let res = await fetch(`https://api.themoviedb.org/3/movie/popular?api_key=2b4489582d1f2b3d42ac22f7e28d7e07&language=en-US&page=1`);

        let data = await res.json();

        console.log(data.results);
        showPopularMovies(data.results);

    }

    getPopularMovies();

    function showPopularMovies(data){
        let popular = document.getElementById("popular_movies");

        data.forEach(e => {
            let container = document.createElement("div");

            container.onclick = async function () {
                let res = await fetch(`https://api.themoviedb.org/3/movie/${e.id}/external_ids?api_key=2b4489582d1f2b3d42ac22f7e28d7e07`);
                let dat = await res.json();
                // console.log(dat.imdb_id);
                requestDataForTitle(dat.imdb_id);
                window.scrollTo(0, 0);
            }

            let image = document.createElement("img");
            image.src = `https://image.tmdb.org/t/p/w500${e.poster_path}`;

            let name = document.createElement("p");
            name.innerText = e.title;

            let date = document.createElement("p");
            date.innerText ="Release date: " + e.release_date;

            container.append(image, name, date);

            popular.append(container);

        })
    }

</script>

</html>